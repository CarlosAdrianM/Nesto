<UserControl x:Class="PlantillaVentaView" 
             Name="Plantilla"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:local="clr-namespace:Nesto.Modulos.PlantillaVenta"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             xmlns:controlesusuario="clr-namespace:ControlesUsuario;assembly=ControlesUsuario"
             xmlns:converters="clr-namespace:ControlesUsuario.Converters;assembly=ControlesUsuario"
             xmlns:controls="clr-namespace:Nesto.Modulos.PlantillaVenta"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             prism:ViewModelLocator.AutoWireViewModel="True">

    <UserControl.Resources>
        <converters:PercentageConverter x:Key="porcentajeConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </UserControl.Resources>

    <xctk:BusyIndicator Name="IndicadorOcupado" IsBusy="{Binding estaOcupado}" BusyContent="Cargando datos...">
        <Grid>
            <xctk:Wizard Name="WizardPlantilla" 
                         CurrentPage="{Binding PaginaActual, Mode=TwoWay}"
                         CancelButtonVisibility="Hidden"
                         HelpButtonVisibility="Hidden"
                         CancelButtonClosesWindow="False"
                         FinishButtonClosesWindow="False" 
                         BackButtonContent="&lt; Anterior"
                         NextButtonContent="Siguiente &gt;"
                         FinishButtonContent="Finalizar">
                <i:Interaction.Triggers>
                    <i:EventTrigger EventName="Finish">
                        <i:InvokeCommandAction Command="{Binding Path=DataContext.cmdCrearPedido, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" />
                    </i:EventTrigger>
                </i:Interaction.Triggers>
                <xctk:WizardPage x:Name="SeleccionCliente" 
                                       Title="Selección del cliente"
                                       Description="Lo primero que debemos hacer es seleccionar el cliente al que vamos a enviar el pedido. Escriba las primeras letras del nombre, dirección, teléfono o población y pulse la tecla Enter. A continuación seleccione un cliente entre los que aparezcan y se cargará su plantilla para ayudarle a realizar el pedido."
                                       CanSelectNextPage="{Binding hayUnClienteSeleccionado}">
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0">
                            <Border HorizontalAlignment="Stretch" BorderThickness="3" BorderBrush="AliceBlue">
                                <DockPanel HorizontalAlignment="Stretch">
                                    <TextBlock DockPanel.Dock="Right"  Margin="3" HorizontalAlignment="Right" Width="16" FontFamily="Segoe UI Symbol" FontSize="16" Text="🔎" />
                                    <TextBox DockPanel.Dock="Left" Name="txtFiltroCliente" Text="{Binding filtroCliente, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextBoxPlaceholder}" Tag="Introduce algún dato del cliente..." PreviewMouseLeftButtonUp="txtFiltroCliente_MouseUp">
                                        <TextBox.InputBindings>
                                            <KeyBinding Command="{Binding cmdCargarClientesVendedor}" Key="Enter" />
                                        </TextBox.InputBindings>
                                    </TextBox>
                                </DockPanel>
                            </Border>
                        </StackPanel>

                        <!-- Issue #286: Panel de Borradores - Siempre visible para que el usuario conozca la funcionalidad -->
                        <Expander Grid.Row="1" Margin="0,5,0,5" IsExpanded="{Binding HayBorradores, Mode=OneWay}">
                            <Expander.Header>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="📋 Borradores guardados" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding NumeroBorradores, StringFormat=' ({0})'}" VerticalAlignment="Center"
                                               Visibility="{Binding HayBorradores, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    <Button Content="🔄" Margin="10,0,0,0" Padding="5,0"
                                            Command="{Binding ActualizarListaBorradoresCommand}"
                                            ToolTip="Actualizar lista de borradores"
                                            Background="Transparent" BorderThickness="0"/>
                                </StackPanel>
                            </Expander.Header>
                            <Border BorderBrush="Orange" BorderThickness="1" CornerRadius="3" Padding="5" Background="#FFF9E6">
                                <StackPanel>
                                    <!-- Mensaje cuando NO hay borradores -->
                                    <TextBlock Text="No hay borradores guardados. Los borradores se crean automáticamente cuando falla el envío de un pedido, o manualmente al cerrar la plantilla."
                                               FontStyle="Italic" Foreground="Gray" TextWrapping="Wrap" Margin="0,0,0,5">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HayBorradores}" Value="False">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <!-- Lista de borradores cuando SÍ hay -->
                                    <StackPanel Visibility="{Binding HayBorradores, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <TextBlock Text="Seleccione un borrador para recuperar un pedido no enviado:" Margin="0,0,0,5" FontStyle="Italic"/>
                                        <ScrollViewer MaxHeight="200" VerticalScrollBarVisibility="Auto">
                                            <ItemsControl ItemsSource="{Binding ListaBorradores}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border BorderBrush="LightGray" BorderThickness="1" Margin="0,2" Padding="5" CornerRadius="3" Background="White">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>
                                                                <StackPanel Grid.Column="0">
                                                                    <TextBlock Text="{Binding Descripcion}" FontWeight="SemiBold" TextWrapping="Wrap"/>
                                                                    <TextBlock Text="{Binding MensajeError}" Foreground="Red" FontSize="10" TextWrapping="Wrap" MaxWidth="400">
                                                                        <TextBlock.Style>
                                                                            <Style TargetType="TextBlock">
                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding MensajeError}" Value="{x:Null}">
                                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                                    </DataTrigger>
                                                                                    <DataTrigger Binding="{Binding MensajeError}" Value="">
                                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBlock.Style>
                                                                    </TextBlock>
                                                                </StackPanel>
                                                                <Button Grid.Column="1" Content="📥 Cargar" Margin="5,0" Padding="10,3"
                                                                        Command="{Binding DataContext.CargarBorradorCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                        CommandParameter="{Binding}"
                                                                        ToolTip="Cargar este borrador en la plantilla"/>
                                                                <Button Grid.Column="2" Content="📋" Padding="5,3"
                                                                        Command="{Binding DataContext.CopiarBorradorJsonCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                        CommandParameter="{Binding}"
                                                                        ToolTip="Copiar JSON del borrador al portapapeles"/>
                                                                <Button Grid.Column="3" Content="🗑" Foreground="Red" Padding="5,3"
                                                                        Command="{Binding DataContext.EliminarBorradorCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                        CommandParameter="{Binding}"
                                                                        ToolTip="Eliminar borrador"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </Expander>

                        <ListView Name="listViewClientes" Grid.Row="2" ItemsSource="{Binding listaClientes}" SelectedItem="{Binding clienteSeleccionado}" HorizontalContentAlignment="Stretch">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderThickness="2" BorderBrush="{Binding colorEstado}" CornerRadius="5">
                                        <Grid Height="110" Margin="6">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <StackPanel Grid.Column="0" Width="110" Height="110">
                                                <Image Source="{Binding rutaLogo}"/>
                                            </StackPanel>

                                            <StackPanel Grid.Column="1" VerticalAlignment="Top" Margin="10,0,0,0">
                                                <TextBlock Text="{Binding nombre}" FontWeight="Bold" TextWrapping="NoWrap"/>
                                                <TextBlock Text="{Binding direccion}" TextWrapping="NoWrap"/>
                                                <TextBlock Text="{Binding poblacion}" MaxHeight="60"/>
                                                <TextBlock Text="{Binding cliente}" FontStyle="Italic"/>
                                                <TextBlock Text="{Binding comentarios}" MaxHeight="60"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Grid>
                </xctk:WizardPage>
                <xctk:WizardPage x:Name="SeleccionProductos" PageType="Interior"
                                       Title="Productos que componen el pedido"
                                       Description="Ahora es el momento de seleccionar los productos que el cliente desea que le enviemos. Puede ir poniendo filtros para facilitar la búsqueda, y pulsando la tecla Enter se quedarán fijos (para quitarlos hay que pulsar Enter dejando el campo de filtrar en blanco). Si el producto que desea el cliente no lo ha comprado anteriormente, puede localizarlo pulsando el botón de Buscar en todos los productos y filtrando posteriormente los resultados."
                                       NextPage="{Binding ElementName=SeleccionRegalos}"
                                       PreviousPage="{Binding ElementName=SeleccionCliente}"
                                       CanSelectNextPage="{Binding hayProductosEnElPedido}">

                    <Grid HorizontalAlignment="Stretch">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>

                        <Grid Grid.Row="0" Grid.RowSpan="3" Grid.Column="0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <!-- Botones de búsqueda -->
                            <Grid Grid.Row="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition/>
                                    <ColumnDefinition/>
                                    <ColumnDefinition/>
                                </Grid.ColumnDefinitions>
                                <Button Grid.Column="0" Name="btnBuscar" Command="{Binding cmdBuscarEnTodosLosProductos}" CommandParameter="{Binding ListaFiltrableProductos.Filtro}">
                                    <AccessText>_Buscar en todos los productos</AccessText>
                                </Button>
                                <Grid Grid.Column="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Botón principal -->
                                    <Button Grid.Column="0"
                                            Name="btnBuscarContextual"
                                            Command="{Binding BuscarContextualCommand}"
                                            CommandParameter="{Binding ListaFiltrableProductos.Filtro}">
                                        <AccessText>Búsqueda _contextual</AccessText>
                                    </Button>

                                    <!-- Botón de flechita -->
                                    <Button Grid.Column="1"
                                            Padding="0"
                                            Width="20"
                                            IsEnabled="{Binding IsEnabled, ElementName=btnBuscarContextual}"
                                            Click="OpcionesBusqueda_Click">
                                        <Path Width="8" Height="5" Stretch="Uniform" Fill="Black"
                                              Data="M 0 0 L 4 4 L 8 0 Z"/>
                                        <Button.ContextMenu>
                                            <ContextMenu Name="cmOpcionesBusqueda">
                                                <MenuItem Header="Incluye cualquiera de las palabras"
                                                          IsCheckable="True"
                                                          IsChecked="{Binding EsBusquedaConOR, Mode=TwoWay}" />
                                                <MenuItem Header="Incluye todas las palabras"
                                                          IsCheckable="True"
                                                          IsChecked="{Binding EsBusquedaConAND, Mode=TwoWay}" />
                                            </ContextMenu>
                                        </Button.ContextMenu>
                                    </Button>

                                </Grid>

                                <Button Grid.Column="2" Name="btnSoloConStock" Command="{Binding SoloConStockCommand}">
                                    <AccessText>Mostrar solo con _Stock</AccessText>
                                </Button>
                            </Grid>
                            <!-- Control reutilizable SelectorLineasPlantillaVenta con BarraFiltro integrada -->
                            <controls:SelectorLineasPlantillaVenta
                                x:Name="lstProductos"
                                Grid.Row="1"
                                ListaFiltrable="{Binding ListaFiltrableProductos}"
                                SelectedItem="{Binding ListaFiltrableProductos.ElementoSeleccionado, Mode=TwoWay}"
                                ActualizarProductoCommand="{Binding cmdActualizarProductosPedido}"
                                PermitirCantidadOferta="True"
                                MostrarPrecio="True"
                                MostrarBarraFiltro="True"/>
                        </Grid>

                        <Grid  Grid.Row="0" Grid.Column="1" Margin="3,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*"/>
                                <ColumnDefinition/>
                                <ColumnDefinition/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" ToolTip="Pulse el botón derecho del ratón para copiar los datos del cliente al portapapeles">
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="MouseRightButtonUp">
                                        <i:InvokeCommandAction Command="{Binding Path=DataContext.CopiarClientePortapapelesCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=StackPanel}}" />
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                                <TextBlock>                                    
                                    <Run Text="{Binding clienteSeleccionado.cliente}"></Run>
                                    <Run Text=" - "></Run>
                                    <Run Text="{Binding clienteSeleccionado.nombre}"></Run>
                                </TextBlock>
                                <TextBlock Text="{Binding clienteSeleccionado.direccion}"></TextBlock>
                                <TextBlock Text="{Binding clienteSeleccionado.poblacionConCodigoPostal}"></TextBlock>
                                <TextBlock Text="{Binding clienteSeleccionado.telefono}"></TextBlock>
                            </StackPanel>
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="{Binding clienteSeleccionado.vendedor}"></TextBlock>
                                <TextBlock Text="{Binding baseImponiblePedido, StringFormat=c}"></TextBlock>
                                <TextBlock Text="{Binding totalPedido, StringFormat=c}"></TextBlock>
                                <TextBox Text="{Binding clienteSeleccionado.iva}" IsReadOnly="True" Background="Transparent" BorderThickness="0">
                                    <i:Interaction.Triggers>
                                        <i:EventTrigger EventName="MouseDoubleClick" >
                                            <i:InvokeCommandAction Command="{Binding CambiarIvaCommand}" />
                                        </i:EventTrigger>
                                    </i:Interaction.Triggers>
                                </TextBox>
                            </StackPanel>
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Base Imponible para Portes"></TextBlock>
                                <TextBlock Text="{Binding baseImponibleParaPortes, StringFormat=c}"></TextBlock>
                                <ComboBox ItemsSource="{Binding listaAlmacenes}" SelectedItem="{Binding almacenSeleccionado}" DisplayMemberPath="Nombre" IsEnabled="{Binding NoHayProductosEnElPedido}"></ComboBox>
                            </StackPanel>
                        </Grid>

                        <DockPanel Grid.Row="2" Grid.Column="1" >
                            <DataGrid DockPanel.Dock="Bottom" ItemsSource="{Binding listaUltimasVentas}" AutoGenerateColumns="False" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" ColumnWidth="*"  CanUserAddRows="False" IsReadOnly="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Fecha" Binding="{Binding fecha, StringFormat=d}" />
                                    <DataGridTextColumn Header="Cantidad" Binding="{Binding cantidad}" />
                                    <DataGridTextColumn Header="Bruto Unidad" Binding="{Binding precioBruto, StringFormat=c}">
                                        <DataGridTextColumn.CellStyle>
                                            <Style>
                                                <Setter Property="FrameworkElement.HorizontalAlignment" Value="Right" />
                                            </Style>
                                        </DataGridTextColumn.CellStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Descuentos" Binding="{Binding descuentos, StringFormat=p}" />
                                    <DataGridTextColumn Header="Neto Unidad" Binding="{Binding precioNeto, StringFormat=c}">
                                        <DataGridTextColumn.CellStyle>
                                            <Style>
                                                <Setter Property="FrameworkElement.HorizontalAlignment" Value="Right" />
                                            </Style>
                                        </DataGridTextColumn.CellStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                            <DataGrid Name="grdListaProductos" DockPanel.Dock="Top" ItemsSource="{Binding listaProductosPedido}" AutoGenerateColumns="False" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" ColumnWidth="*"  CanUserAddRows="False" IsSynchronizedWithCurrentItem="True" SelectedItem="{Binding productoPedidoSeleccionado}">
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="MouseDoubleClick">
                                        <i:InvokeCommandAction Command="{Binding Path=DataContext.CargarProductoCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" CommandParameter="{Binding}" />
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                                <DataGrid.Resources>
                                    <Style TargetType="{x:Type DataGridCell}" BasedOn="{StaticResource {x:Type DataGridCell}}">
                                        <Style.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Foreground" Value="{Binding RelativeSource={RelativeSource Self}, Path=Foreground}" />
                                                <Setter Property="Background" Value="WhiteSmoke"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGrid.Resources>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Producto" Binding="{Binding producto}" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="Texto" Binding="{Binding texto}" Width="3*" IsReadOnly="False"/>
                                    <DataGridTextColumn Header="Tamaño" Binding="{Binding tamanno}" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="Und.M." Binding="{Binding unidadMedida}" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="Familia" Binding="{Binding familia}" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="SubGrupo" Binding="{Binding subGrupo}" Width="2*" IsReadOnly="True"/>
                                    <DataGridTextColumn Header="Cantidad" Binding="{Binding cantidad}" IsReadOnly="False">
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="CellEditEnded">
                                                <i:InvokeCommandAction Command="{Binding Path=DataContext.cmdActualizarProductosPedido, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" CommandParameter="{Binding}" />
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                        <DataGridTextColumn.CellStyle>
                                            <Style>
                                                <Setter Property="FrameworkElement.HorizontalAlignment" Value="Right" />
                                            </Style>
                                        </DataGridTextColumn.CellStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Oferta" Binding="{Binding cantidadOferta}" IsReadOnly="False">
                                        <i:Interaction.Triggers>
                                            <i:EventTrigger EventName="CellEditEnded">
                                                <i:InvokeCommandAction Command="{Binding Path=DataContext.cmdActualizarProductosPedido, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" CommandParameter="{Binding}" />
                                            </i:EventTrigger>
                                        </i:Interaction.Triggers>
                                        <DataGridTextColumn.CellStyle>
                                            <Style TargetType="DataGridCell">
                                                <Setter Property="FrameworkElement.HorizontalAlignment" Value="Right" />
                                                <Setter Property="IsEnabled" Value="{Binding aplicarDescuentoFicha}" />
                                            </Style>
                                        </DataGridTextColumn.CellStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Precio" Binding="{Binding precio, StringFormat=c}" IsReadOnly="False">
                                        <DataGridTextColumn.CellStyle>
                                            <Style TargetType="DataGridCell">
                                                <Setter Property="FrameworkElement.HorizontalAlignment" Value="Right" />
                                                <Setter Property="IsEnabled" Value="{Binding precioHabilitado}" />
                                            </Style>
                                        </DataGridTextColumn.CellStyle>
                                    </DataGridTextColumn>
                                    <DataGridTemplateColumn Header="% Dto.">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding descuento, Converter={StaticResource porcentajeConverter}}"
                                                           HorizontalAlignment="Right"
                                                           IsEnabled="{Binding aplicarDescuento}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                        <DataGridTemplateColumn.CellEditingTemplate>
                                            <DataTemplate>
                                                <TextBox x:Name="txtDescuento"
                                                         Text="{Binding descuento, Converter={StaticResource porcentajeConverter}, UpdateSourceTrigger=LostFocus}"
                                                         HorizontalAlignment="Stretch"
                                                         IsEnabled="{Binding aplicarDescuento}"
                                                         Loaded="TextBox_Loaded"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellEditingTemplate>
                                        <DataGridTemplateColumn.CellStyle>
                                            <Style TargetType="DataGridCell">
                                                <Setter Property="IsEnabled" Value="{Binding aplicarDescuento}" />
                                                <EventSetter Event="PreviewMouseLeftButtonDown" Handler="DataGridCell_PreviewMouseLeftButtonDown"/>
                                            </Style>
                                        </DataGridTemplateColumn.CellStyle>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Base Imp." Binding="{Binding baseImponible, StringFormat=c}" IsReadOnly="True">
                                        <DataGridTextColumn.CellStyle>
                                            <Style TargetType="DataGridCell">
                                                <Setter Property="FrameworkElement.HorizontalAlignment" Value="Right" />
                                            </Style>
                                        </DataGridTextColumn.CellStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow">
                                        <Setter Property="TextElement.Foreground" Value="{Binding colorStock}"/>
                                        <Setter Property="Background" Value="{Binding colorSobrePedido}"/>
                                    </Style>
                                </DataGrid.RowStyle>
                            </DataGrid>
                        </DockPanel>
                        <StackPanel Grid.Row="3" Grid.Column="1" VerticalAlignment="Bottom" Margin="3,0">
                            <TextBlock TextWrapping="Wrap">Este comentario lo verá el compañero de almacén que prepare el pedido. El cliente no ve este comentario.</TextBlock>
                            <TextBox Text="{Binding clienteSeleccionado.comentarioPicking}"/>
                        </StackPanel>
                    </Grid>
                </xctk:WizardPage>
                <!-- Issue #94: Sistema Ganavisiones - FASE 7 - Página de selección de regalos -->
                <xctk:WizardPage x:Name="SeleccionRegalos" PageType="Interior"
                                       Title="Selección de Regalos (Ganavisiones)"
                                       Description="Según el importe del pedido en productos bonificables, puede seleccionar regalos para su cliente. Cada 10 € de base imponible en Cosmética, Accesorios o Peluquería genera 1 Ganavision que puede canjear por productos."
                                       NextPage="{Binding ElementName=SeleccionEntrega}"
                                       PreviousPage="{Binding ElementName=SeleccionProductos}"
                                       CanSelectNextPage="{Binding PuedePasarDePaginaRegalos}">
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="Enter">
                            <i:InvokeCommandAction Command="{Binding Path=DataContext.cmdCargarProductosBonificables, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" />
                        </i:EventTrigger>
                    </i:Interaction.Triggers>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- IZQUIERDA: Selector de productos bonificables con BarraFiltro integrada -->
                        <controls:SelectorLineasPlantillaVenta
                            x:Name="lstRegalos"
                            Grid.Column="0"
                            ListaFiltrable="{Binding ListaFiltrableRegalos}"
                            ActualizarProductoCommand="{Binding cmdActualizarRegalo}"
                            PermitirCantidadOferta="False"
                            MostrarPrecio="True"
                            MostrarBarraFiltro="True"/>

                        <!-- DERECHA: Indicadores y resumen -->
                        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                        <Grid Margin="10,0,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Icono de Ganavisiones -->
                            <Image Grid.Row="0" Source="/Nesto;component/Images/Ganavisiones.png" Width="128" Height="128" HorizontalAlignment="Center" Margin="0,0,0,10"/>

                            <!-- Indicadores de Ganavisiones -->
                            <Border Grid.Row="1" BorderBrush="LightGray" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                <StackPanel>
                                    <TextBlock Text="GANAVISIONES" FontWeight="Bold" FontSize="14" HorizontalAlignment="Center" Margin="0,0,0,10"/>

                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition/>
                                            <RowDefinition/>
                                        </Grid.RowDefinitions>

                                        <StackPanel Grid.Column="0" Grid.Row="0" Margin="5">
                                            <TextBlock Text="Disponibles" FontWeight="Bold" FontSize="11"/>
                                            <TextBlock Text="{Binding GanavisionesDisponibles}" FontSize="24" Foreground="Green" HorizontalAlignment="Center"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1" Grid.Row="0" Margin="5">
                                            <TextBlock Text="Usados" FontWeight="Bold" FontSize="11"/>
                                            <TextBlock FontSize="24" HorizontalAlignment="Center">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Foreground" Value="Orange"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding GanavisionesExcedidos}" Value="True">
                                                                <Setter Property="Foreground" Value="Red"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                                <Run Text="{Binding GanavisionesUsados, Mode=OneWay}"/>
                                            </TextBlock>
                                        </StackPanel>

                                        <StackPanel Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1" Margin="5">
                                            <ProgressBar Height="25" Value="{Binding PorcentajeGanavisionesUsados, Mode=OneWay}" Maximum="100">
                                                <ProgressBar.Style>
                                                    <Style TargetType="ProgressBar">
                                                        <Setter Property="Foreground" Value="Green"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding GanavisionesExcedidos}" Value="True">
                                                                <Setter Property="Foreground" Value="Red"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ProgressBar.Style>
                                            </ProgressBar>
                                            <TextBlock HorizontalAlignment="Center" FontSize="10" Margin="0,3,0,0">
                                                <Run Text="{Binding PorcentajeGanavisionesUsados, Mode=OneWay}"/>
                                                <Run Text="% utilizado"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Base Imponible Bonificable -->
                            <Border Grid.Row="2" BorderBrush="LightGray" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                <StackPanel>
                                    <TextBlock Text="Base Imponible Bonificable" FontWeight="Bold" FontSize="11"/>
                                    <TextBlock Text="{Binding BaseImponibleBonificable, StringFormat=c}" FontSize="20" Foreground="DarkBlue" HorizontalAlignment="Center"/>
                                    <TextBlock Text="(grupos COS, ACC, PEL)" FontSize="10" Foreground="Gray" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <!-- Mensaje de advertencia si se exceden los Ganavisiones -->
                            <Border Grid.Row="3" Background="LightCoral" Padding="10" CornerRadius="5" Margin="0,0,0,10"
                                    Visibility="{Binding GanavisionesExcedidos, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="¡Atención! Ha seleccionado más regalos de los que tiene disponibles. Reduzca la cantidad para continuar."
                                           Foreground="DarkRed" FontWeight="Bold" TextWrapping="Wrap"/>
                            </Border>

                            <!-- Lista de regalos seleccionados -->
                            <Border Grid.Row="4" BorderBrush="LightGray" BorderThickness="1" CornerRadius="5" Padding="10">
                                <DockPanel>
                                    <TextBlock DockPanel.Dock="Top" Text="Regalos seleccionados:" FontWeight="Bold" Margin="0,0,0,5"/>
                                    <ListView ItemsSource="{Binding ListaRegalosSeleccionados}">
                                        <ListView.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="{Binding cantidad}" FontWeight="Bold" Margin="0,0,5,0"/>
                                                    <TextBlock Text="x"/>
                                                    <TextBlock Text="{Binding texto}" Margin="5,0,0,0"/>
                                                    <TextBlock Text="{Binding ganavisiones, StringFormat=' ({0} Gan.)'}" Foreground="Gray"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>
                                </DockPanel>
                            </Border>
                        </Grid>
                        </ScrollViewer>
                    </Grid>
                </xctk:WizardPage>
                <xctk:WizardPage x:Name="SeleccionEntrega" PageType="Interior"
                                       Title="Dirección de Entrega del Pedido"
                                       Description="¿Dónde quiere que le entreguemos el pedido?">
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="Enter">
                            <i:InvokeCommandAction Command="{Binding Path=DataContext.cmdCargarFormasVenta, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" />
                        </i:EventTrigger>
                    </i:Interaction.Triggers>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition/>
                            <ColumnDefinition/>
                        </Grid.ColumnDefinitions>
                        <controlesusuario:SelectorDireccionEntrega Grid.Column="0" x:Name="selectorEntrega" Empresa="{Binding clienteSeleccionado.empresa}" Cliente="{Binding clienteSeleccionado.cliente}" Seleccionada="{Binding ContactoSeleccionado, Mode=TwoWay}" DireccionCompleta="{Binding direccionEntregaSeleccionada, Mode=TwoWay}" TotalPedido="{Binding TotalPedidoPlazosPago}" VerticalContentAlignment="Stretch"></controlesusuario:SelectorDireccionEntrega>
                        <StackPanel Grid.Column="1">
                            <TextBlock TextWrapping="Wrap" Margin="3,0">Este comentario lo leerá la agencia y también el cliente, porque aparecerá en la factura:</TextBlock>
                            <TextBox TextWrapping="Wrap" Text="{Binding ComentarioRuta}" Margin="3,0"/>
                            <CheckBox Content="Servir Junto" IsChecked="{Binding direccionEntregaSeleccionada.servirJunto}" Margin="3,0">
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="Unchecked">
                                        <i:InvokeCommandAction Command="{Binding cmdValidarServirJunto}"/>
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                            </CheckBox>
                            <CheckBox Content="Mantener Junto" IsChecked="{Binding direccionEntregaSeleccionada.mantenerJunto}" Margin="3,0"/>
                            <TextBlock Margin="3,0">
                                <Run Text="Periodo de Facturación:"></Run>
                                <Run Text="{Binding direccionEntregaSeleccionada.periodoFacturacion}"></Run>
                            </TextBlock>
                            <TextBlock></TextBlock>
                            <TextBlock Margin="3,0">Fecha de entrega:</TextBlock>
                            <Grid Margin="3,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition/>
                                    <ColumnDefinition Width="3*"/>
                                </Grid.ColumnDefinitions>
                                <xctk:DateTimePicker Grid.Column="0" Minimum="{Binding fechaMinimaEntrega}" Format="ShortDate" AutoCloseCalendar="True" TimePickerVisibility="Hidden"  Value="{Binding fechaEntrega}"></xctk:DateTimePicker>
                            </Grid>
                            <TextBlock></TextBlock>
                            <TextBlock></TextBlock>
                            <TextBlock Text="{Binding textoFacturacionElectronica}" Margin="3,0"></TextBlock>
                        </StackPanel>
                    </Grid>
                </xctk:WizardPage>
                <xctk:WizardPage x:Name="Finalizar" PageType="Interior"
                                 Title="Finalizar"
                                 NextButtonVisibility="Hidden"
                                 Description="Ya tenemos toda la información necesaria. Pulse el botón finalizar para crear el pedido en Nesto."
                                 CanFinish="{Binding SePuedeFinalizar}">
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="Enter">
                            <!--i:InvokeCommandAction Command="{Binding Path=DataContext.cmdCargarFormasPago, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" /-->
                            <i:InvokeCommandAction Command="{Binding Path=DataContext.cmdCalcularSePuedeServirPorGlovo, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" />
                            <!--i:InvokeCommandAction Command="{Binding Path=DataContext.cmdCargarPlazosPago, RelativeSource={RelativeSource FindAncestor, AncestorType=ItemsControl}}" /-->
                        </i:EventTrigger>
                    </i:Interaction.Triggers>

                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <StackPanel Grid.Row="0">
                            <TextBlock>Seleccione la forma de venta del pedido:</TextBlock>
                            <RadioButton Content="Directa" IsChecked="{Binding formaVentaDirecta,Mode=TwoWay}"/>
                            <RadioButton Content="Teléfono" IsChecked="{Binding formaVentaTelefono,Mode=TwoWay}"/>
                            <StackPanel Orientation="Horizontal">
                                <RadioButton Content="Otras: " IsChecked="{Binding formaVentaOtras,Mode=TwoWay}"/>
                                <ComboBox MinWidth="300" IsEnabled="{Binding formaVentaOtras}" ItemsSource="{Binding listaFormasVenta}" SelectedItem="{Binding formaVentaOtrasSeleccionada}" DisplayMemberPath="descripcion"></ComboBox>
                            </StackPanel>
                        </StackPanel>
                        <Grid Grid.Row="2">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <!--TextBlock Grid.Row="0" Margin="3">Seleccione la forma de pago y los plazos:</TextBlock-->
                            <!--ComboBox Grid.Row="1" MinWidth="300" ItemsSource="{Binding listaFormasPago}" SelectedItem="{Binding formaPagoSeleccionada}" DisplayMemberPath="descripcion" Margin="3"></ComboBox-->
                            <controlesusuario:SelectorFormaPago  Grid.Row="1" MinWidth="300" Configuracion="{Binding configuracion}" Empresa="{Binding clienteSeleccionado.empresa}" Cliente="{Binding clienteSeleccionado.cliente}" Seleccionada="{Binding FormaPagoCliente, Mode=TwoWay}" FormaPagoCompleta="{Binding FormaPagoSeleccionada, Mode=TwoWay}" TotalPedido="{Binding TotalPedidoPlazosPago}" TipoIva="{Binding clienteSeleccionado.iva}" Margin="3"></controlesusuario:SelectorFormaPago>
                            <controlesusuario:SelectorPlazosPago Grid.Row="2" MinWidth="300" Configuracion="{Binding configuracion}" Empresa="{Binding clienteSeleccionado.empresa}" Cliente="{Binding clienteSeleccionado.cliente}" Seleccionada="{Binding PlazoPagoCliente, Mode=TwoWay}" PlazoPagoCompleto="{Binding plazoPagoSeleccionado, Mode=TwoWay}" FormaPago="{Binding FormaPagoSeleccionada.formaPago, Mode=TwoWay}" TotalPedido="{Binding TotalPedidoPlazosPago}" Margin="3"></controlesusuario:SelectorPlazosPago>
                            <TextBlock Grid.Row="3" Grid.Column="0" Margin="3,10,0,0" Visibility="{Binding TienePedidosPendientes, Converter={StaticResource BooleanToVisibilityConverter}}">Ampliar en el pedido:</TextBlock>
                            <ComboBox Grid.Row="4"  Grid.Column="0" ItemsSource="{Binding ListaPedidosPendientes}" SelectedItem="{Binding PedidoPendienteSeleccionado}" Margin="3"  Visibility="{Binding TienePedidosPendientes, Converter={StaticResource BooleanToVisibilityConverter}}"></ComboBox>
                            <Button Grid.Row="5" Grid.Column="0" Margin="3" Command="{Binding NoAmpliarPedidoCommand}"  Visibility="{Binding TienePedidosPendientes, Converter={StaticResource BooleanToVisibilityConverter}}">No Ampliar Pedido</Button>
                            <CheckBox Grid.Row="0" Grid.Column="1" IsChecked="{Binding MandarCobroTarjeta}" Visibility="{Binding EsTarjetaPrepago, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="3">¿Mandar cobro por tarjeta?</CheckBox>
                            <xctk:WatermarkTextBox Grid.Row="1" Grid.Column="1" Text="{Binding CobroTarjetaCorreo}" Watermark="Correo electrónico para el cobro con tarjeta" Visibility="{Binding MandarCobroTarjeta, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="3"></xctk:WatermarkTextBox>
                            <xctk:WatermarkTextBox Grid.Row="2" Grid.Column="1" Text="{Binding CobroTarjetaMovil}" Watermark="Móvil para el cobro con tarjeta" Visibility="{Binding MandarCobroTarjeta, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="3"></xctk:WatermarkTextBox>
                        </Grid>

                        <StackPanel Grid.Row="4">
                            <CheckBox IsChecked="{Binding EsPresupuesto}">¿Crear como Presupuesto?</CheckBox>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <StackPanel Grid.Row="0"  Orientation="Horizontal" Visibility="{Binding SePuedeServirConGlovo, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <Image Source="../Images/entrega_urgente.png"/>
                                </StackPanel>
                                <TextBlock Grid.Row="0" Foreground="Red" Visibility="{Binding SePodriaServirConGlovoEnPrepago, Converter={StaticResource BooleanToVisibilityConverter}}">Si hay PREPAGO podría servirse en 2 horas</TextBlock>
                                <CheckBox Grid.Row="1" IsChecked="{Binding EnviarPorGlovo}" Visibility="{Binding SePuedeServirConGlovo, Converter={StaticResource BooleanToVisibilityConverter}}">Entrega en 2 horas</CheckBox>

                                <Grid Grid.Row="3" Visibility="{Binding EnviarPorGlovo, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition/>
                                    </Grid.RowDefinitions>
                                    <TextBlock Grid.Row="0" Grid.Column="0" Margin="3,0">Portes:</TextBlock>
                                    <TextBox Grid.Row="0" Grid.Column="1" IsEnabled="False" Text="{Binding PortesGlovo, StringFormat=c}"></TextBox>
                                </Grid>
                            </Grid>
                        </StackPanel>
                    </Grid>
                </xctk:WizardPage>
            </xctk:Wizard>
        </Grid>
    </xctk:BusyIndicator>
</UserControl>
